```{r}

################
# Load packages
################

# Required packages
if (!require(pacman))
  install.packages("pacman")

pacman::p_load(dplyr,
               Hmisc,
               tidyr,
               imputeTS,
               impute,
               lubridate,
               tidymodels,
               tidyverse,
               ranger,
               randomForest,
               glmnet,
               here,
               formattable,
               dlookr,
               yardstick,
               gridExtra,
               VIM,
               DMwR2)
```

```{r}

############
# Load data
############

original_data <- read_csv(here('./data/arlington-2022.csv'))
original_data
#shortened_data <- head(original_data, 100)
#shortened_data |> formattable()

# Creating a "SunLogisticValues" column
# (The below no longer matters)
#shortened_data <- shortened_data %>%
#  mutate(SunLogisticValues = !is.na(Sunset))
#shortened_data

write.csv(shortened_data, "C:/Users/kendallbeaver/Downloads/just_column_data.csv", row.names = FALSE)
```

```{r}
# Convert Riyanishi's Python code into R code to categorize day and night

categorize_day_night <- function(hour) {
  if (hour >= 6 && hour < 18) {
    return('Daytime')
  } else {
    return('Nighttime')
  }
}

# Apply the function to your datasets
original_data$Day_Night <- sapply(original_data$Hour, categorize_day_night)
#dallas$Day_Night <- sapply(dallas$Hour, categorize_day_night)
#denton$Day_Night <- sapply(denton$Hour, categorize_day_night)
```

```{r}

##################################################
# Separate sunset & sunrise into distinct datasets
##################################################

# The below is already in POSIX format
# original_data$DATE <- as.POSIXct(original_data$DATE, format = "%Y-%m-%d %H:%M:%S")

# Extract time from the DATE column (which has DATE & TIME smashed together in one cell)
original_data$DateOnly <- format(original_data$DATE, "%H:%M")
#original_data$SunriseFormatted <- as.POSIXct(original_data$Sunrise, format = "%H:%M")

original_data$SunriseFormatted <- ifelse(!is.na(original_data$Sunrise) & is.numeric(original_data$Sunrise), format(strptime(as.numeric(original_data$Sunrise), format = "%H%M"), "%H:%M"), NA)
original_data$SunriseFormatted

#original_data$SunriseFormatted <- format(strptime(as.numeric(original_data$Sunrise), format = "%H%M"), "%H:%M")


original_data$SunriseFormatted

write.csv(original_data, "C:/Users/kendallbeaver/Downloads/mutated_data.csv", row.names = FALSE)
```

```{r}
#####################
# Show missing values
#####################

missing_values <- original_data %>% 
  summarise_all(list(~ sum(is.na(.))))

#missing_values <- original_data %>% summarize_all(funs(sum(is.na(.))))

#original_data <- any(is.na(original_data))
#original_data[original_data == ""] <- NA

missing_values
```

```{r}
############
# Clean data
############

# First, remove the "REM" column

original_data <- original_data %>% select(-DATE)

# The asterick needs to be imputed as a missing value

original_data[original_data == "*"] <- NA

# Convert "T" to "NA", then "VRB" to "NA"
original_data$HourlyPrecipitation <- ifelse(original_data$HourlyPrecipitation == "T", NA, original_data$HourlyPrecipitation)

original_data$HourlyPrecipitation <- ifelse(original_data$HourlyPrecipitation == "VRB", NA, original_data$HourlyPrecipitation)

# Remove "-s" from end of data

original_data <- mutate_all(original_data, ~sub("s$", "", .))

#original_data$HourlyPrecipitation <- sub("s$", "", original_data$HourlyPrecipitation)

original_data
```

```{r}

# Missing values

missing_values <- original_data %>% 
  summarise_all(list(~ sum(is.na(.))))

descending_list_of_missing_values <- original_data %>% 
  summarise_all(list(~ sum(is.na(.)))) %>% 
  gather(key = "column", value = "missing_count") %>%
  arrange(desc(missing_count))

descending_list_of_missing_values

write.csv(original_data, "C:/Users/kendallbeaver/Downloads/imputed_data.csv", row.names = FALSE)

imputed_data <- knnImputation(original_data, k = 50, meth="median")
imputed_data
```

\

![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAaCAYAAACpSkzOAAABAklEQVR42mNgGAVDCqxdvzVhzcbNm6mBK6uqVuO06P///4xr128pptSSmtrarSCz8Ppq//79LGs3bGkl15K6hsZ9IDOICsJFO3dyr1m/tZdUS+obGw+D9JIUX6tW7eZfs2HLLGItaWxqPQXSQ17iWLtDEhiMSwhZ0tzceh6klqKUuGrjdvU1G7esxGVJU0vbJZAaqiT7NRs36q3ZsHU9hiWtbVdBclTNY6vXb3YAWrYJHlyt7ddAYrTJ0Bs2h0B80n4dxB4t4lAA4yK/zdTAhC1a4LOZYZsnRRhsBkGLZntRbhHIDIIWTfek3CKQGQQtmuxGuUUgMwiCPpfNVMGjYMgBAEpfBd1AknheAAAAAElFTkSuQmCC "Run All Chunks Above")![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAaCAYAAADFTB7LAAAAa0lEQVR42u3OywnAIBBAwcXSUoCW5D11xDoNCBGNv0MOecJOBSOi1OZMsJ4dvFxEJ1OQnMxBarIKEpNNkJbsBknJYZCSnAYJyVVQziNig7/nZkFEbhTE5HpBVO4dxOXKIDL3BLG5BJ1T6rsbMfep2CaMN00AAAAASUVORK5CYII= "Run Current Chunk")

```{r}
# Extract "Daily" columns

columns_to_extract <- c("HourlyDryBulbTemperature",
                        "HourlyWetBulbTemperature",
                        "HourlyDewPointTemperature",
                        "HourlyStationPressure",
                        "HourlyRelativeHumidity",
                        "HourlyWindSpeed")

daily_data_arlington <- original_data[, columns_to_extract]

daily_data_arlington <- mutate_all(daily_data_arlington, function(x) ifelse(x < 0, 0, x))

char_columns <- sapply(daily_data_arlington, is.character)

daily_data_arlington[, char_columns] <- lapply(daily_data_arlington[, char_columns], as.numeric)
#daily_data_arlington |> summary()

daily_data_arlington <- mutate_all(daily_data_arlington, ~sub("s$", "", .))
#daily_data_arlington

daily_data_arlington[is.na(daily_data_arlington)] <- NA

#daily_data_arlington <- impute(daily_data_arlington)
#daily_data_arlington <- as.numeric(daily_data_arlington)

#max_decimal <- max(nchar(sub(".*\\.", "", as.character(daily_data_arlington))))
#formatted_data <- sprintf(paste0("%.", max_decimal, "f"), daily_data_arlington)
#daily_data_arlington <- head(formatted_data, 362)

#daily_data_arlington <- head(daily_data_arlington, 361)
#daily_data_arlington

###################
# ROWS TO REMOVE!!!
###################
rows_to_remove <- c(361, 362, 364, 5008, 5214, 5215, 5216, 5221, 5222, 5876, 6499, 6705, 6715, 8077, 8078, 8079)
# There's some type of glitch where it thinks 5231 & 5232 are "5221 & 5222"

daily_data_arlington <- daily_data_arlington[-rows_to_remove, ]
daily_data_arlington
```

```{r}
###################################################
# Imputing subset to isolate "knnImputation" issues
###################################################

subset_1_arlington_data <- daily_data_arlington[0:5000, ]
subset_1_arlington_data
imputed_data <- knnImputation(subset_1_arlington_data, k = 10, meth="median")
imputed_data

subset_2_arlington_data <- daily_data_arlington[8700:10000, ]
subset_2_arlington_data
imputed_data <- knnImputation(subset_2_arlington_data, k = 10, meth="median")
imputed_data

#daily_data_arlington <- data.matrix(daily_data_arlington)
#imputed_data <- knnImputation(daily_data_arlington, k = 10, meth="median")
#imputed_data

# Subset the first 362 rows of the dataset
#subset_data <- head(daily_data_arlington, 362)
#any(is.na(subset_data))
#imputed_data <- knnImputation(subset_data, k = 10, meth = "median")


#write.csv(daily_data_arlington, "C:/Users/kendallbeaver/Downloads/imputed_data.csv", row.names = FALSE)
```

```{r}

# Impute Arlington dataset

imputed_data <- knnImputation(daily_data_arlington, k = 20, meth="median")
imputed_data
```
